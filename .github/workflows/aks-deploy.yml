name: Deploy to AKS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Azure CLI Login
      run: |
        echo "Logging into Azure using Service Principal..."
        az login --service-principal \
          --username ${{ secrets.AZURE_CLIENT_ID }} \
          --password ${{ secrets.AZURE_CLIENT_SECRET }} \
          --tenant ${{ secrets.AZURE_TENANT_ID }}

        echo "Setting subscription..."
        az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

        echo "Getting AKS credentials..."
        az aks get-credentials --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} --name ${{ secrets.AKS_CLUSTER_NAME }}

        echo "Listing AKS nodes..."
        kubectl get nodes

    - name: Install Linkerd
      run: |
        echo "1"
        curl -sL https://run.linkerd.io/install | sh
        echo "2"
        export PATH=$PATH:/home/$(whoami)/.linkerd2/bin
        echo "3"
        linkerd install --crds | kubectl apply -f -
        echo "5"
        linkerd install | kubectl apply -f -
        echo "7"
        linkerd viz install | kubectl apply -f -
        echo "9"
        kubectl get deploy -o yaml | linkerd inject - | kubectl apply -f -

    - name: Install KEDA
      run: |
        helm repo add kedacore https://kedacore.github.io/charts
        helm repo update
        helm install keda kedacore/keda --namespace keda --create-namespace
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
        helm install prometheus prometheus-community/prometheus --namespace monitoring --create-namespace
        kubectl apply --server-side -f https://github.com/kedacore/keda/releases/download/v2.16.0/keda-2.16.0-crds.yaml
        kubectl apply -f k8s/ --recursive

