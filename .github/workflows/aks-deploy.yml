name: Deploy to AKS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Azure CLI Login
      run: |
        echo "Logging into Azure using Service Principal..."
        az login --service-principal \
          --username ${{ secrets.AZURE_CLIENT_ID }} \
          --password ${{ secrets.AZURE_CLIENT_SECRET }} \
          --tenant ${{ secrets.AZURE_TENANT_ID }}

        echo "Setting subscription..."
        az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

        echo "Getting AKS credentials..."
        az aks get-credentials --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} --name ${{ secrets.AKS_CLUSTER_NAME }}

        echo "Listing AKS nodes..."
        kubectl get nodes

    - name: Generate and Install Linkerd
      run: |
        # Install Linkerd
        curl -sL https://run.linkerd.io/install | sh

        # Add Linkerd CLI to PATH
        export PATH=$PATH:/home/runner/.linkerd2/bin

        # Validate Linkerd installation
        linkerd check --pre

        # Install Linkerd CRDs
        linkerd install --crds | kubectl apply -f -

        # Install Linkerd control plane
        linkerd install | kubectl apply -f -

        # Check Linkerd installation
        linkerd check

        # Install Linkerd Viz extension for monitoring (optional)
        linkerd viz install | kubectl apply -f -
        linkerd viz check

    - name: Inject Linkerd into existing deployments
      run: |
        # Apply Linkerd injection to deployments in the specified namespace
        kubectl get deploy -o yaml --namespace <your-namespace> | linkerd inject - | kubectl apply -f -

    - name: Apply Kubernetes resources
      run: |
        # Apply Kubernetes resources from the k8s directory
        kubectl apply -f k8s/ --recursive

    - name: Install KEDA and Prometheus
      run: |
        # Install KEDA
        helm repo add kedacore https://kedacore.github.io/charts
        helm repo update
        helm install keda kedacore/keda --namespace keda --create-namespace

        # Install Prometheus for monitoring
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
        helm install prometheus prometheus-community/prometheus --namespace monitoring --create-namespace

        # Apply KEDA CRDs
        kubectl apply --server-side -f https://github.com/kedacore/keda/releases/download/v2.16.0/keda-2.16.0-crds.yaml
        kubectl apply -f k8s/ --recursive
